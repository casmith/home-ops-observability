---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: kube-prometheus-stack
  namespace: observability
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: kube-prometheus-stack
  install:
    remediation:
      retries: 3
    crds: CreateReplace
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
    crds: CreateReplace
  values:
    cleanPrometheusOperatorObjectNames: true

    # Disable scraping of the observability cluster's kube components (we're monitoring the main cluster)
    kubeApiServer:
      enabled: true
    kubeControllerManager:
      enabled: false
    kubeScheduler:
      enabled: false
    kubeEtcd:
      enabled: false
    kubeProxy:
      enabled: false

    # Prometheus configuration
    prometheus:
      prometheusSpec:
        externalUrl: https://prometheus-obs.kalde.in
        retention: 90d
        retentionSize: 450GB

        # Resource limits
        resources:
          requests:
            cpu: 500m
            memory: 4Gi
          limits:
            cpu: 2000m
            memory: 8Gi

        # NFS Storage
        storageSpec:
          volumeClaimTemplate:
            spec:
              storageClassName: nfs-client
              accessModes: ["ReadWriteOnce"]
              resources:
                requests:
                  storage: 500Gi

        # Security context
        securityContext:
          runAsNonRoot: true
          runAsUser: 65534
          runAsGroup: 65534
          fsGroup: 65534

        # Monitor selectors - scrape everything
        podMonitorSelectorNilUsesHelmValues: false
        probeSelectorNilUsesHelmValues: false
        ruleSelectorNilUsesHelmValues: false
        scrapeConfigSelectorNilUsesHelmValues: false
        serviceMonitorSelectorNilUsesHelmValues: false

        # Federation from main cluster via internal DNS (Pi-hole)
        # Pi-hole will resolve prometheus.kalde.in to internal gateway IP
        additionalScrapeConfigs:
          - job_name: 'federate-main-cluster'
            scrape_interval: 60s
            scrape_timeout: 45s
            honor_labels: true
            metrics_path: '/federate'
            params:
              'match[]':
                - '{job=~".+"}'
            static_configs:
              - targets:
                  - 'prometheus.kalde.in'
                labels:
                  cluster: main
            scheme: https
            tls_config:
              insecure_skip_verify: true

    # Node exporter
    prometheus-node-exporter:
      fullnameOverride: node-exporter
      resources:
        requests:
          cpu: 100m
          memory: 128Mi
        limits:
          cpu: 500m
          memory: 256Mi

    # Kube state metrics
    kube-state-metrics:
      fullnameOverride: kube-state-metrics

    # Alertmanager
    alertmanager:
      enabled: true
      alertmanagerSpec:
        configSecret: alertmanager-config
        storage:
          volumeClaimTemplate:
            spec:
              storageClassName: nfs-client
              accessModes: ["ReadWriteOnce"]
              resources:
                requests:
                  storage: 10Gi

    # Disable default alert rules we don't need
    defaultRules:
      disabled:
        Watchdog: true
        PrometheusOutOfOrderTimestamps: true

    # Disable Grafana (we'll deploy separately)
    grafana:
      enabled: false
      forceDeployDashboards: true
