---
# Alertmanager email configuration
# Fill in your SMTP details and encrypt with: sops -e -i alertmanager-config.sops.yaml
apiVersion: v1
kind: Secret
metadata:
  name: alertmanager-smtp-config
  namespace: observability
type: Opaque
stringData:
  config.yaml: |
    global:
      smtp_from: 'alerts@yourdomain.com'  # CHANGE: Your "from" email address
      smtp_smarthost: 'smtp.example.com:587'  # CHANGE: Your SMTP server and port
      smtp_auth_username: 'your-email@example.com'  # CHANGE: SMTP username
      smtp_auth_password: 'your-password-here'  # CHANGE: SMTP password
      smtp_require_tls: true

    route:
      receiver: 'email-notifications'
      group_by: ['alertname', 'cluster', 'severity']
      group_wait: 10s
      group_interval: 5m
      repeat_interval: 4h
      routes:
        - match:
            severity: critical
          receiver: 'email-notifications'
          continue: false

    receivers:
      - name: 'email-notifications'
        email_configs:
          - to: 'your-email@example.com'  # CHANGE: Where to send alerts
            headers:
              Subject: '[{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .GroupLabels.alertname }}'
            html: |
              <!DOCTYPE html>
              <html>
              <head>
                <style>
                  body { font-family: Arial, sans-serif; }
                  .alert { padding: 15px; margin: 10px 0; border-left: 4px solid; }
                  .critical { border-color: #d32f2f; background-color: #ffebee; }
                  .warning { border-color: #f57c00; background-color: #fff3e0; }
                  .info { border-color: #1976d2; background-color: #e3f2fd; }
                </style>
              </head>
              <body>
                <h2>Alert: {{ .GroupLabels.alertname }}</h2>
                <p><strong>Status:</strong> {{ .Status | toUpper }}</p>
                <p><strong>Cluster:</strong> {{ .GroupLabels.cluster }}</p>

                {{ range .Alerts }}
                <div class="alert {{ .Labels.severity }}">
                  <h3>{{ .Annotations.summary }}</h3>
                  <p>{{ .Annotations.description }}</p>
                  <p><strong>Severity:</strong> {{ .Labels.severity }}</p>
                  <p><strong>Started:</strong> {{ .StartsAt }}</p>
                  {{ if .EndsAt }}<p><strong>Ended:</strong> {{ .EndsAt }}</p>{{ end }}
                </div>
                {{ end }}
              </body>
              </html>
