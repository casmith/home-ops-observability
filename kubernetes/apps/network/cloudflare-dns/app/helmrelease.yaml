---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/helmrelease-helm-v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app cloudflare-dns
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: cloudflare-dns
  install:
    remediation:
      retries: -1
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  values:
    fullnameOverride: *app

    # RBAC configuration
    rbac:
      create: true

    # Service account
    serviceAccount:
      create: true
      name: cloudflare-dns

    # Provider configuration
    provider: cloudflare

    # Cloudflare environment variables
    env:
      - name: CF_API_TOKEN
        valueFrom:
          secretKeyRef:
            name: &secret cloudflare-dns-secret
            key: api-token

    # Extra arguments
    extraArgs:
      - --cloudflare-dns-records-per-page=1000
      # CRITICAL: Exclude IPv6 to prevent AAAA records that cause connection issues
      - --exclude-target-net=::/0

    # Label filter to only process DNSEndpoints labeled for cloudflare
    labelFilter: external-dns.io/provider=cloudflare

    # Trigger loop on events for faster updates
    triggerLoopOnEvent: true

    # Sources to watch for DNS entries
    sources:
      - crd

    # Policy - sync to create/update/delete records
    policy: sync

    # TXT registry for tracking managed records (different from main cluster!)
    txtOwnerId: obs-cluster
    txtPrefix: k8s.

    # Domain filter - manage kalde.in zone but limit with txtOwnerId (isolated from main cluster!)
    domainFilters:
      - kalde.in

    # Service monitor
    serviceMonitor:
      enabled: true

    # Pod annotations for secret reloader
    podAnnotations:
      secret.reloader.stakater.com/reload: *secret

    # Log level
    logLevel: info
